import { generateObject } from 'ai';
import { z } from 'zod';
import { AgentContext } from './types';

export type IntentType = 'chat' | 'generate_regulation';

export async function classifyIntent(context: AgentContext): Promise<IntentType> {
  const { messages, userPrompt, model } = context;

  // Context for intent classification (last 6 messages)
  const intentContext = messages
    .slice(-6)
    .map((msg) => `${msg.role}: ${msg.content}`)
    .join('\n');

  const lastMessage = messages[messages.length - 1];
  const lastText = typeof lastMessage.content === 'string' ? lastMessage.content : '';

  // Heuristic regex patterns for common edit commands
  const regulationPatterns = [
    /—É–±–µ—Ä–∏\s/i,
    /—É–¥–∞–ª–∏\s/i,
    /–¥–æ–±–∞–≤—å\s/i,
    /–∏—Å–ø—Ä–∞–≤—å\s/i,
    /–∑–∞–º–µ–Ω–∏\s/i,
    /–ø–µ—Ä–µ–¥–µ–ª–∞–π\s/i,
    /–∏–∑–º–µ–Ω–∏\s/i,
    /–ø–µ—Ä–µ–ø–∏—à–∏\s/i,
    /—Å—Ñ–æ—Ä–º–∏—Ä—É–π/i,
    /—Å–æ–∑–¥–∞–π/i,
    /—Å–æ—Å—Ç–∞–≤—å/i,
    /–Ω–∞–ø–∏—à–∏/i,
    /–≤—ã–≤–µ–¥–∏.*–ø–∞–Ω–µ–ª/i, // "–≤—ã–≤–µ–¥–∏ –≤ –ø–∞–Ω–µ–ª–∏", "–≤—ã–≤–µ–¥–∏ –≤ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏"
    /–ø–æ–∫–∞–∂–∏.*–ø–∞–Ω–µ–ª/i, // "–ø–æ–∫–∞–∂–∏ –≤ –ø–∞–Ω–µ–ª–∏"
    /–æ—Ç–æ–±—Ä–∞–∑–∏.*–ø–∞–Ω–µ–ª/i,
    /–≤–Ω–µ—Å–∏\s+–ø—Ä–∞–≤–∫/i,
    /–æ–±–Ω–æ–≤–∏\s/i,
  ];

  // Check if last message matches any regulation pattern
  for (const pattern of regulationPatterns) {
    if (pattern.test(lastText)) {
      console.log(`üéØ Heuristic match: "${lastText.slice(0, 50)}" -> generate_regulation`);
      return 'generate_regulation';
    }
  }

  try {
    const { object: intentObj } = await generateObject({
      model,
      temperature: 0.1,
      schema: z.object({
        type: z.enum(['chat', 'generate_regulation']),
      }),
      system: `
–¢—ã ‚Äî —É–º–Ω—ã–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –Ω–∞–º–µ—Ä–µ–Ω–∏–π –≤ –¥–∏–∞–ª–æ–≥–µ. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥: "chat" (–æ–±—â–µ–Ω–∏–µ, —Å–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∞–Ω–∞–ª–∏–∑) –∏–ª–∏ "generate_regulation" (—Ä–∞–±–æ—Ç–∞ —Å –¥–æ–∫—É–º–µ–Ω—Ç–æ–º: —Å–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ).

–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:
1. "generate_regulation" –≤—ã–±–∏—Ä–∞–π –µ—Å–ª–∏:
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç "—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å", "—Å–æ–∑–¥–∞—Ç—å", "–Ω–∞–ø–∏—Å–∞—Ç—å", "—Å–æ—Å—Ç–∞–≤–∏—Ç—å" –¥–æ–∫—É–º–µ–Ω—Ç/—Ä–µ–≥–ª–∞–º–µ–Ω—Ç.
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç "–≤—ã–≤–µ—Å—Ç–∏", "–ø–æ–∫–∞–∑–∞—Ç—å", "–æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å" –¥–æ–∫—É–º–µ–Ω—Ç –≤ –ø–∞–Ω–µ–ª–∏/–æ–∫–Ω–µ.
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç "–∏–∑–º–µ–Ω–∏—Ç—å", "–∏—Å–ø—Ä–∞–≤–∏—Ç—å", "–¥–æ–±–∞–≤–∏—Ç—å", "—É–±—Ä–∞—Ç—å", "–ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å", "–æ–±–Ω–æ–≤–∏—Ç—å" —á—Ç–æ-—Ç–æ –≤ —Ç–µ–∫—É—â–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–µ.
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç "–≤–Ω–µ—Å–∏ –ø—Ä–∞–≤–∫–∏", "—Å–¥–µ–ª–∞–π –∫–∞–∫ —è —Å–∫–∞–∑–∞–ª", "–ø—Ä–∏–º–µ–Ω–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è" (–æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ –¥–æ–∫—É–º–µ–Ω—Ç—É).
   - –ê–≥–µ–Ω—Ç –ø—Ä–µ–¥–ª–æ–∂–∏–ª —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç, –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–≥–ª–∞—Å–∏–ª—Å—è ("–¥–∞–≤–∞–π", "–¥–∞", "—Å–æ–≥–ª–∞—Å–µ–Ω" –ü–û–°–õ–ï –æ–±—Å—É–∂–¥–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞).
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ –ø–æ —Ç–µ–∫—Å—Ç—É –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–£–±–µ—Ä–∏ –ø—É–Ω–∫—Ç 1.3", "–ó–∞–º–µ–Ω–∏ —Å–ª–æ–≤–æ X –Ω–∞ Y", "–î–æ–±–∞–≤—å —Ä–∞–∑–¥–µ–ª –ø—Ä–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å").

2. –í–æ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö –≤—ã–±–∏—Ä–∞–π "chat". –í –¢–û–ú –ß–ò–°–õ–ï:
   - –ï—Å–ª–∏ –∏–¥–µ—Ç –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –ë–ï–ó —è–≤–Ω–æ–π –ø—Ä–æ—Å—å–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∑–∏–ª —Ñ–∞–π–ª—ã –∏ –ø—Ä–æ—Å–∏—Ç –∏—Ö –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å (–±–µ–∑ –ø—Ä–æ—Å—å–±—ã —Å—Ä–∞–∑—É —Å–¥–µ–ª–∞—Ç—å —Ä–µ–≥–ª–∞–º–µ–Ω—Ç).
   - –ö–æ—Ä–æ—Ç–∫–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ç–∏–ø–∞ "–í—Å–µ –≤–µ—Ä–Ω–æ" –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ —Å–±–æ—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–∫–æ–≥–¥–∞ –µ—â—ë –ù–ï –≥–æ—Ç–æ–≤—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç).

–ü–†–ò–ú–ï–†–´ (Few-Shot):
User: "–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?" -> {"type": "chat"}
User: "–î–∞–≤–∞–π —Å–æ—Å—Ç–∞–≤–∏–º —Ä–µ–≥–ª–∞–º–µ–Ω—Ç" -> {"type": "generate_regulation"}
User: "–°–æ—Å—Ç–∞–≤—å —Ä–µ–≥–ª–∞–º–µ–Ω—Ç" -> {"type": "generate_regulation"}
User: "–¢–µ–ø–µ—Ä—å –≤—ã–≤–µ–¥–∏ –º–Ω–µ –µ–≥–æ –≤ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏" -> {"type": "generate_regulation"}
User: "–ü–æ–∫–∞–∂–∏ –¥–æ–∫—É–º–µ–Ω—Ç –≤ –ø–∞–Ω–µ–ª–∏" -> {"type": "generate_regulation"}
User: "–£–±–µ—Ä–∏ –ø—É–Ω–∫—Ç 1.3" -> {"type": "generate_regulation"}
User: "–î–æ–±–∞–≤—å —Ä–∞–∑–¥–µ–ª –ø—Ä–æ —à—Ç—Ä–∞—Ñ—ã" -> {"type": "generate_regulation"}
User: "–ú–Ω–µ –Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –ø—É–Ω–∫—Ç 2, –ø–µ—Ä–µ–ø–∏—à–∏ –µ–≥–æ" -> {"type": "generate_regulation"}
User: "–ê —á—Ç–æ –µ—Å–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å —à—Ç—Ä–∞—Ñ—ã?" (–≤–æ–ø—Ä–æ—Å/–æ–±—Å—É–∂–¥–µ–Ω–∏–µ) -> {"type": "chat"}
User: "–í—Å–µ –≤–µ—Ä–Ω–æ" (–≤ –Ω–∞—á–∞–ª–µ —Å–±–æ—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏) -> {"type": "chat"}
User: "–í—Å–µ –≤–µ—Ä–Ω–æ, —Å–æ–∑–¥–∞–π —Ä–µ–≥–ª–∞–º–µ–Ω—Ç" (—è–≤–Ω–∞—è –ø—Ä–æ—Å—å–±–∞) -> {"type": "generate_regulation"}
`,
      prompt: `
–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è):
"""
${intentContext}
"""

–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
"""
${lastText}
"""

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON —Ñ–æ—Ä–º–∞—Ç–∞ {"type":"<–æ–¥–Ω–æ –∏–∑ –∑–Ω–∞—á–µ–Ω–∏–π>"}.
`,
    });
    
    console.log('ü§ñ Intent classified:', intentObj.type);
    return intentObj.type;
  } catch (err) {
    console.error('Intent classification failed, defaulting to chat:', err);
    return 'chat';
  }
}
